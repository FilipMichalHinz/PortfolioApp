<div class="detail-container">

  <!-- üîÑ Loading Spinner -->
  <div *ngIf="isLoading" class="loading-spinner">
    Loading portfolio...
  </div>

  <ng-container *ngIf="!isLoading">

    <!-- üîπ Header -->
    <header class="detail-header">
      <button class="back-btn" routerLink="/portfolio-list">‚Üê Back</button>
      <h1 class="title">{{ portfolio.portfolioName || ('Portfolio ' + summary.portfolioId) }}</h1>
    </header>

    <!-- üîπ Charts -->
    <section class="charts-panel">

      <!-- üîπ Allocation Pie -->
      <div class="chart-wrapper">
        <div class="chart-title">Allocation Pie</div>

        <ngx-charts-pie-chart *ngIf="allocationPieData?.length" [results]="allocationPieData"
          [colorScheme]="colorScheme" [view]="[400, 300]" [labels]="true" [doughnut]="true">
        </ngx-charts-pie-chart>
      </div>

    </section>

    <!-- üìâ Metrics Overview -->
    <section class="metrics-panel">
      <div class="metric-card">
        <div class="label">Invested</div>
        <div class="value">{{ summary.initialInvestment | currency }}</div>
      </div>
      <div class="metric-card">
        <div class="label">Current Value</div>
        <div class="value">{{ summary.currentValue | currency }}</div>
      </div>
      <div class="metric-card">
        <div class="label">Total P/L</div>
        <div class="value" [class.positive]="summary.totalProfitLoss >= 0"
          [class.negative]="summary.totalProfitLoss < 0">
          {{ summary.totalProfitLoss | currency }}
          <span class="pct">({{ summary.changePercent | number:'1.0-0' }}%)</span>
        </div>
      </div>
      <div class="metric-card">
        <div class="label">Finalized P/L</div>
        <div class="value" [class.positive]="totalFinalizedProfit >= 0" [class.negative]="totalFinalizedProfit < 0">
          {{ totalFinalizedProfit | currency }}
          <span class="pct">({{ totalFinalizedReturnPercent | number:'1.0-0' }}%)</span>
        </div>
      </div>
      <div class="metric-card">
        <div class="label">Open P/L</div>
        <div class="value" [class.positive]="totalOpenProfit >= 0" [class.negative]="totalOpenProfit < 0">
          {{ totalOpenProfit | currency }}
          <span class="pct">({{ totalOpenReturnPercent | number:'1.0-0' }}%)</span>
        </div>
      </div>
    </section>

    <!-- üìä Assets -->
    <section class="assets-panel">

      <!-- üîπ Open Positions header with toggle -->
      <div class="assets-header" (click)="openPositionsExpanded = !openPositionsExpanded" style="cursor: pointer;">
        <span>{{ openPositionsExpanded ? '‚ñ≤' : '‚ñº' }}</span>
        <h2>Open Positions</h2>
      </div>

      <!-- üîπ This wrapper ALWAYS shows when expanded -->
      <div *ngIf="openPositionsExpanded">

        <!-- ‚úÖ Add Item button (always visible when expanded) -->
        <div class="add-item-wrapper">
          <button class="add-btn" *ngIf="!showForm" (click)="showForm = true">+ Add Item</button>
        </div>

        <!-- ‚úÖ Form for adding assets -->
        <div *ngIf="showForm">
          <app-portfolio-item-form [portfolioId]="portfolio.id" [itemToEdit]="itemBeingEdited" [editMode]="isEditMode"
            (created)="onItemCreated($event)" (updated)="onItemUpdated($event)" (cancel)="onCancel()">
          </app-portfolio-item-form>
        </div>

        <!-- ‚úÖ Table of open assets -->
        <table *ngIf="summary.byAsset.length > 0">
          <thead>
            <tr>
              <th style="width: 150px;">Actions</th>
              <th>Name</th>
              <th>Ticker</th>
              <th>Qty</th>
              <th>Buy Price</th>
              <th>Current Price</th>
              <th>Value</th>
              <th>Profit/Loss</th>
              <th>Return %</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let a of summary.byAsset">
              <tr *ngIf="!a.isSold">
                <td>
                  <div class="actions-row">
                    <button (click)="startSell(a)">Sell</button>
                    <button (click)="startEdit(a)">Edit</button>
                    <button (click)="deleteItem(a.id)">Delete</button>
                  </div>
                </td>
                <td>{{ a.name || 'Loading...' }}</td>
                <td>{{ a.ticker }}</td>
                <td>{{ a.quantity }}</td>
                <td>{{ a.purchasePrice | currency }}</td>
                <td>{{ a.currentPrice | currency }}</td>
                <td>{{ a.currentValue | currency }}</td>
                <td [class.positive]="a.profitLoss >= 0" [class.negative]="a.profitLoss < 0">
                  {{ a.profitLoss | currency }}
                </td>
                <td>{{ a.changePercent | number:'1.0-0' }}%</td>
              </tr>
            </ng-container>
          </tbody>
        </table>

        <!-- üß† Friendly fallback message if no assets -->
        <div *ngIf="summary?.byAsset?.length === 0 && !showForm" class="no-assets-placeholder">
          No open positions yet. Click "+ Add Item" to get started.
        </div>
      </div>
      <!-- üîπ Completed Trades -->
      <div class="assets-header" (click)="completedTradesExpanded = !completedTradesExpanded" style="cursor: pointer;">
        <span>{{ completedTradesExpanded ? '‚ñ≤' : '‚ñº' }}</span>
        <h2>Completed Positions</h2>
      </div>

      <table *ngIf="summary.byAsset.length > 0 && completedTradesExpanded">
        <thead>
          <tr>
            <th style="width: 150px;">Actions</th>
            <th>Name</th>
            <th>Ticker</th>
            <th>Qty</th>
            <th>Buy Price</th>
            <th>Sell Price</th>
            <th>Sold Date</th>
            <th>Profit/Loss</th>
            <th>Return %</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let a of summary.byAsset">
            <tr *ngIf="a.isSold">
              <td>
                <div class="actions-row">
                  <button (click)="startEdit(a)">Edit</button>
                  <button (click)="deleteItem(a.id)">Delete</button>
                </div>
              </td>
              <td>{{ a.name || 'Loading...' }}</td>
              <td>{{ a.ticker }}</td>
              <td>{{ a.quantity }}</td>
              <td>{{ a.purchasePrice | currency }}</td>
              <td>{{ a.exitPrice | currency }}</td>
              <td>{{ a.exitDate | date }}</td>
              <td>{{ (a.exitPrice! - a.purchasePrice) * a.quantity | currency }}</td>
              <td>{{ ((a.exitPrice! - a.purchasePrice) / a.purchasePrice) * 100 | number:'1.0-0' }}%</td>
            </tr>
          </ng-container>
        </tbody>
      </table>

      <!-- üî• Sell Modal -->
      <div *ngIf="sellMode" class="modal-overlay">
        <div class="modal-content">
          <h3>Sell {{ itemToSell.ticker }}</h3>

          <label for="exitPrice">Exit Price:</label>
          <input id="exitPrice" type="number" [(ngModel)]="itemToSell.exitPrice" name="exitPrice">

          <label for="exitDate">Exit Date:</label>
          <input id="exitDate" type="date" [(ngModel)]="itemToSell.exitDate" name="exitDate">

          <div class="button-row">
            <button (click)="confirmSell()" [disabled]="!itemToSell.exitPrice || !itemToSell.exitDate">Confirm
              Sell</button>
            <button (click)="cancelSell()">Cancel</button>
          </div>
        </div>
      </div>
      <!-- üìù Edit Completed Trade Modal -->
      <div *ngIf="editSellMode" class="modal-overlay">
        <div class="modal-content">
          <h3>Edit Sale for {{ itemToEditSell?.ticker }}</h3>

          <label for="editExitPrice">Exit Price:</label>
          <input id="editExitPrice" type="number" [(ngModel)]="itemToEditSell.exitPrice" />

          <label for="editExitDate">Exit Date:</label>
          <input id="editExitDate" type="date" [(ngModel)]="itemToEditSell.exitDate" />

          <div class="button-row">
            <button (click)="confirmSellEdit()">Save</button>
            <button (click)="editSellMode = false">Cancel</button>
          </div>
        </div>
      </div>

    </section>
  </ng-container>
</div>